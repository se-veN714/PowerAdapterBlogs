{% load static %}
{% load widget_tweaks %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/toastify-js@1.11.2/src/toastify.min.css">
<script src="https://cdn.jsdelivr.net/npm/toastify-js@1.11.2/src/toastify.min.js"></script>

<style>
    /* Bulmaå…¼å®¹çš„Toastifyæ ·å¼ */
    .toastify {
        font-family: BlinkMacSystemFont, -apple-system, "Segoe UI", "Roboto", "Oxygen", "Ubuntu", "Cantarell", "Fira Sans", "Droid Sans", "Helvetica Neue", "Helvetica", "Arial", sans-serif;
        border-radius: 4px;
        box-shadow: 0 3px 6px rgba(0, 0, 0, 0.16), 0 3px 6px rgba(0, 0, 0, 0.23);
    }

    /* ç¦ç”¨çŠ¶æ€åŠ è½½åŠ¨ç”» */
    .button.is-loading::after {
        animation: spinAround .5s infinite linear;
        border: 2px solid #dbdbdb;
        border-radius: 290486px;
        border-right-color: transparent;
        border-top-color: transparent;
        content: "";
        display: block;
        height: 1em;
        position: relative;
        width: 1em;
    }

    @keyframes spinAround {
        from {
            transform: rotate(0deg);
        }
        to {
            transform: rotate(359deg);
        }
    }
</style>

{% block form %}
    <div class="block">
        <div class="container">
            <form id="comment-form" class="box" action="/comment/" method="post">
                {% csrf_token %}

                <article class="media">
                    <div class="media-left">
                        <div class="field">
                            <label class="label">æ˜µç§°</label>
                            <div class="control">
                                {{ comment_form.nickname|add_class:"input" }}
                            </div>
                        </div>
                    </div>
                    <div class="media-content">
                        <div class="field">
                            <label class="label">å†…å®¹</label>
                            <div class="control">
                                {{ comment_form.content|add_class:"textarea" }}
                            </div>
                        </div>

                        <input type="hidden" name="target" value="{{ request.path }}"/>

                        <div class="field">
                            <div class="control">
                                <button id="submit-button" type="submit" class="button is-primary">
                                    <span id="button-text">å†™å¥½äº†ï¼</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </article>
            </form>
        </div>
    </div>
{% endblock %}

<script>
    // è·å–è¡¨å•å’Œæäº¤æŒ‰é’®
    const commentForm = document.getElementById('comment-form');
    const submitButton = document.getElementById('submit-button');
    const buttonText = document.getElementById('button-text');

    // ç›‘å¬è¡¨å•æäº¤äº‹ä»¶
    commentForm.addEventListener('submit', async function (event) {
        // 1. é˜»æ­¢è¡¨å•é»˜è®¤çš„æäº¤è¡Œä¸º
        event.preventDefault();

        // 2. å‡†å¤‡AJAXæäº¤
        const formData = new FormData(commentForm);

        // 3. ç¦ç”¨æäº¤æŒ‰é’®å¹¶æ˜¾ç¤ºåŠ è½½çŠ¶æ€
        submitButton.classList.add('is-loading');
        submitButton.disabled = true;
        buttonText.textContent = 'æäº¤ä¸­...';

        try {
            // 4. å‘é€AJAXè¯·æ±‚
            const response = await fetch(commentForm.action, {
                method: 'POST',
                body: formData,
                headers: {
                    // å¯é€‰ï¼šé€šçŸ¥Djangoè¿™æ˜¯AJAXè¯·æ±‚
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            // 5. è§£ææœåŠ¡å™¨å“åº”
            const data = await response.json();

            // 6. æ ¹æ®å“åº”ç»“æœè¿›è¡Œä¸åŒå¤„ç†
            if (data.success) {
                //æ¸…ç©ºè¡¨å•
                this.reset()
                // æˆåŠŸæ—¶çš„Toastæç¤º
                Toastify({
                    text: "ğŸ‰ è¯„è®ºæäº¤æˆåŠŸï¼",
                    duration: 3000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #00d1b2, #3273dc)",
                    className: "toast-success",
                }).showToast();

                //å°†æ–°è¯„è®ºç½®é¡¶
                const commentsContainer = document.getElementById('comments-container');
                commentsContainer.insertAdjacentHTML('afterbegin', data.html);

                // å¯é€‰ï¼šåˆ·æ–°è¯„è®ºåˆ—è¡¨æˆ–æ˜¾ç¤ºæ–°è¯„è®º
                // refreshComments();
            } else {
                // å¤±è´¥æ—¶çš„Toastæç¤º
                Toastify({
                    text: "âš ï¸ " + data.message,
                    duration: 5000,
                    close: true,
                    gravity: "top",
                    position: "right",
                    backgroundColor: "linear-gradient(to right, #ff3860, #ffdd57)",
                    className: "toast-error",
                }).showToast();

                // 7. å¤„ç†è¡¨å•é”™è¯¯
                if (data.errors) {
                    // éšè—æ‰€æœ‰é”™è¯¯ä¿¡æ¯
                    document.querySelectorAll('.help.is-danger').forEach(el => {
                        el.style.display = 'none';
                    });
                    document.querySelectorAll('.is-danger').forEach(el => el.classList.remove('is-danger'));

                    // æ˜¾ç¤ºæ–°é”™è¯¯
                    for (const field in data.errors) {
                        const errors = data.errors[field];
                        // æ‰¾å‡ºé”™è¯¯æ¶ˆæ¯çš„å®¹å™¨ï¼ˆç›¸é‚»çš„.helpå…ƒç´ ï¼‰
                        const inputEl = document.querySelector(`[name="${field}"]`);
                        if (inputEl) {
                            inputEl.classList.add('is-danger');
                            const errorContainer = inputEl.closest('.field').querySelector('.help');
                            if (errorContainer) {
                                errorContainer.textContent = errors.join(', ');
                                errorContainer.style.display = 'block';
                            }
                        }
                    }
                }
            }
        } catch (error) {
            console.error("AJAX è¯·æ±‚å¤±è´¥ï¼š", error);
            // 8. æ•è·ç½‘ç»œé”™è¯¯

            Toastify({
                text: "âŒ ç½‘ç»œé”™è¯¯ï¼Œè¯·æ£€æŸ¥è¿æ¥å¹¶é‡è¯•",
                duration: 5000,
                close: true,
                gravity: "top",
                position: "right",
                backgroundColor: "linear-gradient(to right, #ff3860, #ff7b29)",
                className: "toast-error",
            }).showToast();
        } finally {
            // 9. æ¢å¤æäº¤æŒ‰é’®çŠ¶æ€
            submitButton.classList.remove('is-loading');
            submitButton.disabled = false;
            buttonText.textContent = 'å†™å¥½äº†ï¼';
        }
    });
</script>
